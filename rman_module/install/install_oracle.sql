-- Tables for RMAN strategies and logs (Oracle 21c XE)
CREATE TABLE RBACKUP_STRATEGY (
  ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  CODE             VARCHAR2(32) NOT NULL UNIQUE,    -- e.g., rmadb0101.rma
  NAME             VARCHAR2(120) NOT NULL,
  TYPE             VARCHAR2(20)  NOT NULL,          -- FULL | INCREMENTAL | PARTIAL | INCOMPLETE
  INCREMENTAL_LVL  NUMBER(1)     DEFAULT 0,         -- 0 | 1
  INCLUDE_CTRLFILE CHAR(1)       DEFAULT 'Y',       -- Y/N
  INCLUDE_ARCHIVE  CHAR(1)       DEFAULT 'Y',       -- Y/N
  PRIORITY         VARCHAR2(12)  NOT NULL,          -- LOW | MEDIUM | HIGH | CRITICAL
  OBJECT_SCOPE     CLOB,                             -- JSON array of tablespaces or datafiles when PARTIAL
  OUTPUT_DIR       VARCHAR2(400) NOT NULL,          -- target dir for pieces and logs
  COMPRESSION      CHAR(1)       DEFAULT 'N',
  ENCRYPTION       CHAR(1)       DEFAULT 'N',
  CREATED_AT       TIMESTAMP     DEFAULT SYSTIMESTAMP,
  UPDATED_AT       TIMESTAMP     DEFAULT SYSTIMESTAMP,
  CONSTRAINT CK_RB_TYPE CHECK (TYPE IN ('FULL','INCREMENTAL','PARTIAL','INCOMPLETE')),
  CONSTRAINT CK_RB_PRIO CHECK (PRIORITY IN ('LOW','MEDIUM','HIGH','CRITICAL')),
  CONSTRAINT CK_RB_YN1  CHECK (INCLUDE_CTRLFILE IN ('Y','N')),
  CONSTRAINT CK_RB_YN2  CHECK (INCLUDE_ARCHIVE IN ('Y','N')),
  CONSTRAINT CK_RB_YN3  CHECK (COMPRESSION IN ('Y','N')),
  CONSTRAINT CK_RB_YN4  CHECK (ENCRYPTION IN ('Y','N'))
);

CREATE TABLE RBACKUP_RUN (
  ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  STRATEGY_ID    NUMBER NOT NULL REFERENCES RBACKUP_STRATEGY(ID),
  STARTED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  ENDED_AT       TIMESTAMP,
  STATUS         VARCHAR2(16) DEFAULT 'RUNNING',   -- RUNNING | SUCCESS | FAILED
  SCRIPT_PATH    VARCHAR2(400),
  LOG_PATH       VARCHAR2(400),
  RETURN_CODE    NUMBER,
  BY_SCHEDULER   CHAR(1) DEFAULT 'N',             -- Y/N
  NOTE           VARCHAR2(400)
);

CREATE TABLE RBACKUP_LOG (
  ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  RUN_ID     NUMBER NOT NULL REFERENCES RBACKUP_RUN(ID),
  TS         TIMESTAMP DEFAULT SYSTIMESTAMP,
  LOG_LEVEL      VARCHAR2(10),                        -- INFO | WARN | ERROR
  MESSAGE    CLOB
);

-- Views for convenience
CREATE OR REPLACE VIEW V_RBACKUP_LATEST AS
SELECT s.ID STRATEGY_ID, s.CODE, s.NAME,
       (SELECT STATUS FROM RBACKUP_RUN r WHERE r.STRATEGY_ID=s.ID
         ORDER BY r.STARTED_AT DESC FETCH FIRST 1 ROWS ONLY) LAST_STATUS,
       (SELECT ENDED_AT FROM RBACKUP_RUN r WHERE r.STRATEGY_ID=s.ID
         ORDER BY r.STARTED_AT DESC FETCH FIRST 1 ROWS ONLY) LAST_ENDED_AT
FROM RBACKUP_STRATEGY s;

-- Grants (adjust to your schema/user)
-- GRANT SELECT, INSERT, UPDATE, DELETE ON RBACKUP_* TO <APP_USER>;
